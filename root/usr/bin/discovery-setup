#!/usr/bin/env ruby
#
# vim: ts=2:sw=2:et
#
# Copyright (C) 2012-2014 Red Hat, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA  02110-1301, USA.  A copy of the GNU General Public License is
# also available at http://www.gnu.org/copyleft/gpl.html.

require 'fileutils'
require 'net/http'
require 'net/https'
require 'uri'
require 'socket'
require 'resolv'

# For comparison
require 'rubygems'
require 'facter'
require 'yaml'
require 'json'

# Our lib
require 'discovery'

# Download zipfile
Dir.chdir '/opt/extension'

# Use a commandline option, fdi.zips=zip1.zip,zip2.zip,etc and
# get the zips from the TFTP server
uri = ENV['ZIP_SERVER']
zips = cmdline('fdi.zips')
unless zips.nil?
  zips.split(',').each do |zip|
    begin
      log_msg "Extension at: tftp://#{uri}/#{zip}"
      tftp_result = %x{/usr/bin/tftp #{uri} -c get #{zip} /tmp/ext.zip}

      # Unpack zip
      if tftp_result.empty?
        %x{/bin/unzip -o /tmp/ext.zip}
      else
        log_msg "TFTP error downloading #{zip}: #{tftp_result}"
      end
    rescue
      # We always want to write /etc/default/discovery so don't bomb out here
      log_err "Problem downloading zipfile #{zip}"
      exit 1
    ensure
      # Cleanup
      File.unlink('/tmp/ext.zip') if File.exists?('/tmp/ext.zip')
    end
  end
end

# Write out environment files for subsequent paths and systemd units to use
File.open('/etc/default/discovery','w') do |f|
  f.write("# EnvironmentFile generated by discovery-setup.service\n")
  f.write(env_append('PATH','/opt/extension/bin'))
  f.write(env_append('FACTERLIB','/usr/share/fdi/facts:/opt/extension/facts'))
  f.write(env_append('LD_LIBRARY_PATH','/opt/extension/lib'))
  f.write(env_append('RUBYLIB','/opt/extension/lib/ruby'))
end

exit 0
