#!/bin/bash

[[ -z "$1" ]] && echo "Usage: $0 fdi-name.ks [FOREMAN_VERSION] [RELEASE_NUMBER] [VERSION]" && exit 1

which git date base64 ksflatten >/dev/null || ( echo "Command(s) missing, install required tools" && exit 2 )

FOREMAN_VERSION=${2:-nightly}
RELEASE=$(date +%Y%m%d).${3:-1}
VERSION=${4:-$(git describe --abbrev=0 --tags)}
KS_INSTALL=fdi-install.ks
KS_TARGET=fdi-image.ks

# prepare version and release files
echo "$VERSION" > root/usr/share/fdi/VERSION
echo "$RELEASE" > root/usr/share/fdi/RELEASE

OVERLAY=$(find root -type f | sort | cut -c 5-)

# generate install overlay
echo "# <generated by build-livecd>" > $KS_INSTALL
cat >> $KS_INSTALL <<EOF
%pre
# VERSION=$VERSION
# RELEASE=$RELEASE
%end
EOF
for FILE in $OVERLAY; do
cat >> $KS_INSTALL <<EOF
%post
mkdir -p \$(dirname $FILE)
base64 -d - >$FILE <<'CODE'
$(cat root$FILE | base64 -w79)
CODE
%end
EOF
done
cat >> $KS_INSTALL <<KS
%post
chmod 755 $(find root -type f -executable | cut -c 5- | xargs echo)
%end
KS
echo "# </generated by build-livecd>" >> $KS_INSTALL

# prepare result kickstart
ksflatten -v RHEL8 -c "$1" -o $KS_TARGET

sed "s|yum.theforeman.org/nightly|yum.theforeman.org/releases/$FOREMAN_VERSION|" -i $KS_TARGET
sed "s|yum.theforeman.org/plugins/nightly|yum.theforeman.org/plugins/$FOREMAN_VERSION|" -i $KS_TARGET


# set variables based on distro
case $1 in
	*rocky8*)
                DISTRO_INSTALL_NAME="Rocky Linux 8"
                DISTRO_INSTALL_ISO_URL="https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.5-x86_64-boot.iso"
		;;
	*alma8*)
                DISTRO_INSTALL_NAME="Alama Linux 8"
                DISTRO_INSTALL_ISO_URL="https://repo.almalinux.org/almalinux/8/isos/x86_64/AlmaLinux-8.6-x86_64-boot.iso"
		;;
	*)
                DISTRO_INSTALL_NAME="Centos 8 Stream"
                DISTRO_INSTALL_ISO_URL="http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/images/boot.iso"
		;;
esac
if [ -f build-livecd-root.conf.sh ]; then
	mv build-livecd-root.conf.sh build-livecd-root.conf.sh.PREV
fi
cat <<EOF > build-livecd-root.conf.sh
#
DISTRO_INSTALL_NAME="${DISTRO_INSTALL_NAME}"
DISTRO_INSTALL_ISO_URL="${DISTRO_INSTALL_ISO_URL}"
EOF


echo "Now run as root ./build-livecd-root or submit $KS_TARGET into koji"
